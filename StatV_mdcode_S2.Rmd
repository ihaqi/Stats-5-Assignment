---
title: "Untitled"
author: "Sigert"
date: "5 June 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache = TRUE)
list.of.packages <- c("knitr","rjags","runjags", "haven","psych","car","magicfor","lattice")
new.packages <- list.of.packages[!(list.of.packages %in%installed.packages()[,"Package"])]
if(length(new.packages)){install.packages(new.packages,repos = "http://cran.us.r-project.org")}
lapply(list.of.packages, require, character.only = TRUE)

set.seed(777)
Mywd<- getwd()
setwd(Mywd)
```

```{r datapreparation, include=FALSE}
## Unique ID's
raw.data <- read.csv("soep_statV.csv", header = TRUE, sep = ",", dec = ".")
clean.data <- transform(raw.data, pp=match(id,unique(id)))

##centering
clean.data$age <-raw.data$age-55

##recoding some variables
clean.data$emplStat55[clean.data$emplStat55 == 2] <- 0
clean.data$emplStat55[clean.data$emplStat55 == 3] <- 0

Nsubjects <- length(unique(clean.data$pp))
Ntotal <- length(clean.data$pp)

measurements <- c(0:5)
Nmeasurements <- length(measurements)


```

```{r Jags preparation, include=FALSE}
##variables
variable.names <- list("id","ls", "age", "employ","health","partner","pp")
colnames(clean.data) <- variable.names

##standardisation

standardized.data.tmp <- matrix(ncol = length(variable.names), nrow = length(clean.data$id))
colnames(standardized.data.tmp) <-list("pp","Zls","age","Zhealth","employ","partner", "Zage")


M.ls <- mean(clean.data$ls)
SD.ls <- sd(clean.data$ls)
M.health <- mean(clean.data$health)
SD.health <- sd(clean.data$health)
M.age <- mean(clean.data$age)
SD.age <- sd(clean.data$age)

for( i in 1:(length(clean.data$id))){
  standardized.data.tmp[i,2] <- (M.ls-clean.data$ls[i])/SD.ls
  standardized.data.tmp[i,1] <- clean.data$pp[i]
  standardized.data.tmp[i,3] <- clean.data$age[i]
  standardized.data.tmp[i,4] <- (M.health-clean.data$health[i])/SD.health
  standardized.data.tmp[i,5] <- clean.data$employ[i]
  standardized.data.tmp[i,6] <- clean.data$partner[i]
  standardized.data.tmp[i,7] <- (M.age - clean.data$age[i])/SD.age
}
standardized.data <- standardized.data.tmp

```

```{r JAGS specifics}
nchains = 2
nadapt = 200 #many uninformative dispersion parameters
nburn = 500
niter = 3000
myinits <- NULL
```


```{r Exploratory Statistics}
# Life satisfaction by age

mean.table1=tapply(clean.data$ls,list(clean.data$age, clean.data$partner),mean)
mean.table3=tapply(clean.data$ls,list(clean.data$age, clean.data$employ),mean)
mean.table4=tapply(clean.data$ls,list(clean.data$age, clean.data$health),mean)

# life satisfaction as a function of Living together and age
colors=c("black","red")
plot(unique(clean.data$age),mean.table1[,1],type="b",xlim=c(0,5),ylim=c(0,10),xlab="Age (in years)",ylab="Life Satisfaction",axes=F,main="Life satisfaction as a function of Living together and age")
axis(side=1,at=c(0,1,2,3,4,5),labels=c(55,56,57,58,59,60))
axis(side=2,at=seq(0,10,1))
box()
points(unique(clean.data$age),mean.table1[,2],type="b",col="red")
# life satisfaction as a function of employement and age

colors=c("black","red")
plot(unique(clean.data$age),mean.table3[,1],type="b",xlim=c(0,5),ylim=c(0,10),xlab="Age (in years)",ylab="Life Satisfaction",axes=F,main="Life satisfaction as a function of employement and age")
axis(side=1,at=c(0,1,2,3,4,5),labels=c(55,56,57,58,59,60))
axis(side=2,at=seq(0,10,1))
box()
points(unique(clean.data$age),mean.table3[,2],type="b",col="red")
# life satisfaction as a function of health status and age

par(xpd=TRUE)
colors=rainbow(10)
plot(unique(clean.data$age),mean.table4[,1],type="n",xlim=c(0,5),ylim=c(0,10),xlab="Age (in years)",ylab="Life satisfaction",axes=F,main="life satisfaction as a function of health status and age")
axis(side=1,at=c(0,1,2,3,4,5),labels=c(55,56,57,58,59,60))
axis(side=2,at=seq(0,10,1))
box()
for(i in 1:length(colors)){
  points(unique(clean.data$age),mean.table4[,1+i],type="b",col=colors[i])
  legend(-0.180, 2, x.intersp = 0.12, legend = colnames(mean.table4), fill = colors, horiz=TRUE)
}

```
```{r model 1}
modelString = "
model {
for ( i in 1:Ntotal ) {
	y[i] ~ dnorm( Beta0[pp[i]] + Beta1[pp[i]]*x[i,3]+ Beta2[pp[i]]*x[i, 4]+Beta3[pp[i]]*x[i,5]+Beta4[pp[i]]*x[i,6], 1/sigma^2 )
} #x3 = age, x4 = zhealth, x5 = employ, x6 = partner
		
for (j in 1:Nsubjects ) {
		Beta0[j] ~ dnorm( beta0mu, 1/(beta0sigma)^2 )
		Beta1[j] ~ dnorm( beta1mu, 1/(beta1sigma)^2 )
		Beta2[j] ~ dnorm( beta2mu, 1/(beta2sigma)^2 )
		Beta3[j] ~ dnorm( beta3mu, 1/(beta3sigma)^2 )
		Beta4[j] ~ dnorm( beta4mu, 1/(beta4sigma)^2 )
}


beta0mu ~ dnorm( 0, 1/(2^10) )
beta1mu ~ dnorm( 0, 1/(2^10) )
beta2mu ~ dnorm( 0, 1/(2^10) )
beta3mu ~ dnorm( 0, 1/(2^10) )
beta4mu ~ dnorm( 0, 1/(2^10) )

beta0sigma ~ dunif( 1.0E-3 , 1.0E+3 )
beta1sigma ~ dunif( 1.0E-3 , 1.0E+3 )
beta2sigma ~ dunif( 1.0E-3 , 1.0E+3 )
beta3sigma ~ dunif( 1.0E-3 , 1.0E+3 )
beta4sigma ~ dunif( 1.0E-3 , 1.0E+3 )

sigma ~ dunif( 1.0E-3 , 1.0E+3 )
}"
writeLines(modelString , con="model_full_no_interaction" )
```

```{r Simple bayesian model}
#no correlation, using standardized data for life satisfaction and health variables

za = standardized.data[, 7]
e = standardized.data[, 5]
p = standardized.data[, 6]
zh = standardized.data[, 4]
xvars <- as.matrix(standardized.data, ncols = length(colnames(standardized.data)))


y = standardized.data[, 2]
pp = standardized.data[, 1]

simple_model <- list(
  y = y,
  pp = pp,
  x = xvars,
  Nsubjects = Nsubjects,
  Ntotal = Ntotal
)

out.simple.model <- run.jags(model = "model_full_no_interaction", monitor = c("beta0mu", "beta1mu", "beta2mu","beta3mu","beta4mu", "Beta0","Beta1","Beta2","Beta3","Beta4"), data = simple_model, inits = myinits, n.chains = nchains, adapt = nadapt, burnin = nburn, sample = niter)

a <- summary(out.simple.model)
b <- lm(y ~ za, e, p, zh)

a
summary(b)
```

